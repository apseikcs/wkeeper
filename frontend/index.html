<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Склад</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="styles/ui-kit.css">
  <link rel="stylesheet" href="styles/pages/index.css">
</head>
<body class="wk-base wk-p-4 xxs:p-none">
  <div class="wk-container xxs:pl-2 xxs:pr-2">
    
    <header class="wk-page-header">
      <div>
        <h1 class="wk-page-title">Склад</h1>
      </div>
      <button id="logoutBtn" class="wk-btn wk-btn-outline wk-flex wk-items-center wk-gap-2">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
        </svg>
        Выйти
      </button>
    </header>
    
    <div class="wk-grid wk-grid-cols-1 wk-grid-cols-md-3 wk-gap-4 wk-mb-6">
      <div class="wk-card stat-card">
        <div class="stat-value" id="totalProducts">—</div>
        <div class="stat-label">Товаров всего</div>
      </div>
      <div class="wk-card stat-card">
        <div class="stat-value" id="todayTransactions">—</div>
        <div class="stat-label">Проводок сегодня</div>
      </div>
      <div class="wk-card stat-card">
        <div class="stat-value" id="lastActivity">—</div>
        <div class="stat-label">Последняя активность</div>
      </div>
    </div>

    <div class="wk-card wk-mb-4">
      <div class="wk-flex wk-flex-col wk-gap-4 md:wk-flex-row wk-justify-between flex-wrap">
        <nav class="wk-nav grow-1 items-center">
          <a class="wk-nav-item active" href="index">Склад</a>
          <a class="wk-nav-item" href="transactions">Проводки</a>
          <a class="wk-nav-item" href="reports">Отчёты</a>
          <a class="wk-nav-item" href="workers">Сотрудники</a>
          <a class="wk-nav-item" href="suppliers">Поставщики</a>
          <a class="wk-nav-item" href="destinations">Объекты</a>
          <a class="wk-nav-item" href="tools">Инструменты</a>
        </nav>
        
        <div class="wk-flex wk-gap-2 wk-flex-wrap justify-start">
          <button id="createProductBtn" class="wk-btn wk-btn-primary wk-btn-sm md:wk-btn">
            Создать товар
          </button>
          <button id="bulkAdjustBtn" class="wk-btn wk-btn-secondary wk-btn-sm md:wk-btn">
            Массовый приход/расход
          </button>
          <button id="refreshBtn" class="wk-btn wk-btn-secondary wk-btn-sm md:wk-btn">
            <span class="wk-loading-spinner hidden"></span>
            Обновить
          </button>
        </div>
      </div>
    </div>

    <div class="wk-card wk-mb-4">
      <div class="wk-flex wk-flex-col wk-gap-3 md:wk-flex-row wk-items-center">
        <label class="wk-flex wk-items-center wk-gap-2">
          <span class="wk-text-sm wk-font-semibold">Поиск</span>
          <div class="search-wrap">
            <input id="productSearch" class="wk-form-input" placeholder="Товар или поставщик" autocomplete="off">
            <div id="prodDropdown" class="dropdown" style="display:none"></div>
          </div>
        </label>
        <button id="clearFilter" class="wk-btn wk-btn-secondary wk-btn-sm">Сбросить</button>
      </div>
    </div>

    <div class="wk-card">
      <div class="wk-card-header">
        <h2 class="wk-card-title">Товары на складе</h2>
      </div>
      <div class="table-container">
        <table class="wk-table" id="productsTable">
          <thead>
            <tr>
              <th><input id="selectAllProducts" type="checkbox" title="Выбрать все"></th>
              <th class="sortable" data-sort="id">ID <span class="sort-arrow" id="sortArrowId">↕</span></th>
              <th class="sortable" data-sort="name">Название <span class="sort-arrow" id="sortArrowName">↕</span></th>
              <th class="sortable" data-sort="supplier">Поставщик <span class="sort-arrow" id="sortArrowSupplier">↕</span></th>
              <th class="sortable" data-sort="quantity">Остаток <span class="sort-arrow" id="sortArrowQuantity">↕</span></th>
              <th class="sortable" data-sort="unit">Ед.изм <span class="sort-arrow" id="sortArrowUnit">↕</span></th>
              <th>Действия</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div class="wk-card wk-mt-6">
      <div class="wk-card-header">
        <h2 class="wk-card-title">Последние проводки</h2>
      </div>
      <div class="table-container">
        <table class="wk-table" id="recentTransactionsTable">
          <thead>
            <tr>
              <th>Дата</th>
              <th>Товар</th>
              <th>Кол-во</th>
              <th>Тип</th>
              <th>Кто/куда</th>
              <th>Автор</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div id="modalRoot"></div>
    <div id="notificationContainer" class="fixed top-4"></div>
  </div>

  <script src="auth.js"></script>
  <script src="js/form-utils.js"></script>
  <script>
    // Global supplier state
    window.allSuppliers = [];

    // Fetch suppliers and update global state
    async function fetchSuppliers() {
      try {
        const res = await authFetch('/api/suppliers');
        const data = await res.json();
        window.allSuppliers = formUtils.extractItems(data);
        return window.allSuppliers;
      } catch (error) {
        console.error('Error fetching suppliers:', error);
        return [];
      }
    }

    // Setup modal backdrop click handler (click outside to close)
    function setupModalBackdropHandler(modalElement, onClose) {
      if (!modalElement) return;
      modalElement.addEventListener('click', (e) => {
        // Only close if clicking on the backdrop itself, not the card
        if (e.target === modalElement) {
          if (onClose) onClose();
          modalElement.remove();
        }
      });
    }

    let isWorker = true; 

    async function applyWorkerRestrictions() {
      try {
        const user = await (window.getCurrentUser ? window.getCurrentUser() : Promise.resolve(null))
        isWorker = !!(user && user.role === 'worker')

        if (!isWorker) return

        document.querySelectorAll('nav.wk-nav a').forEach(a => {
          if (!a.classList.contains('active')) a.style.display = 'none'
        })

        const createBtn = document.getElementById('createProductBtn')
        if (createBtn) createBtn.style.display = 'none'
        // keep bulk button visible for workers per UX decision
        const bulkBtn = document.getElementById('bulkAdjustBtn')

        const selectAll = document.getElementById('selectAllProducts')
        if (selectAll && selectAll.parentElement) selectAll.parentElement.removeChild(selectAll)

        document.querySelectorAll('#productsTable th.sortable').forEach(th => {
          th.style.pointerEvents = 'none'
          th.style.opacity = '0.6'
        })
      } catch (e) {
        console.error('applyWorkerRestrictions error', e)
      }
    }

    function notify(message, type = 'info') {
      try {
        const container = document.getElementById('notificationContainer') || (function(){
          const c = document.createElement('div'); 
          c.id = 'notificationContainer'; 
          c.className = 'notification-container';
          document.body.appendChild(c); 
          return c;
        })();
        const el = document.createElement('div');
        el.className = 'wk-alert ' + (type === 'error' ? 'wk-alert-error' : (type === 'success' ? 'wk-alert-success' : 'wk-alert-info'));
        el.textContent = message;
        container.appendChild(el);
        setTimeout(() => { try { el.remove() } catch(e){} }, 4500);
      } catch (e) { console.error('notify error', e) }
    }

    const formatDate = date => {
      try {
        const d = new Date(date)
        const parts = new Intl.DateTimeFormat('en-GB', {
          timeZone: 'Europe/Moscow',
          year: 'numeric', month: '2-digit', day: '2-digit',
          hour: '2-digit', minute: '2-digit', hour12: false
        }).formatToParts(d)
        const map = {}
        parts.forEach(p => { if (p.type !== 'literal') map[p.type] = p.value })
        return `${map.day}/${map.month}/${map.year} ${map.hour}:${map.minute}`
      } catch (e) { return String(date) }
    }

    let currentProductId = undefined;
    let currentSearch = '';
    let searchTimeout = null;

    let currentSortField = null; 
    let currentSortDir = 'asc';
    let currentPage = 1;
    let pageSize = 75;
    let totalPages = 1; 

    document.addEventListener('DOMContentLoaded', () => {
      applyWorkerRestrictions().then(() => {
        // Fetch initial suppliers list
        fetchSuppliers().then(() => {
          setupEventListeners();
          load();
        });
      })
    });

    function setupEventListeners() {
      document.getElementById('clearFilter').addEventListener('click', () => {
        currentProductId = undefined;
        currentSearch = '';
        currentPage = 1;
        document.getElementById('productSearch').value = '';
        document.getElementById('prodDropdown').style.display = 'none';
        load();
      });

      document.getElementById('productSearch').addEventListener('input', handleSearchInput);
      document.getElementById('productSearch').addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          currentPage = 1;
          document.getElementById('prodDropdown').style.display = 'none';
          load();
        }
      });

      document.getElementById('productsTable').addEventListener('click', (e) => {
        const btn = e.target.closest('button');
        if (!btn) return;
        const id = btn.getAttribute('data-id');
        const action = btn.getAttribute('data-action');
        if (id && action) {
          if (action === 'delete') openDeleteModal(id);
          else openAdjustModal(id, action);
        }
      });

      document.addEventListener('blur', (e) => {
        const cell = e.target;
        if (cell.classList.contains('editable-cell')) {
          const id = cell.getAttribute('data-id');
          const field = cell.getAttribute('data-field');
          const oldVal = cell.getAttribute('data-old-value');
          const newVal = cell.textContent.trim();
          
          if (oldVal !== newVal) {
            openConfirmEditModal(id, field, oldVal, newVal, cell);
          }
        }
      }, true);

      document.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && e.target.classList.contains('editable-cell')) {
          e.preventDefault();
          e.target.blur();
        }
      });

      document.getElementById('createProductBtn').addEventListener('click', openCreateProductModal);

      document.getElementById('refreshBtn').addEventListener('click', () => {
        const spinner = document.querySelector('#refreshBtn .wk-loading-spinner');
        spinner.classList.remove('hidden');
        load().finally(() => {
          spinner.classList.add('hidden');
        });
      });
      
      document.getElementById('logoutBtn').addEventListener('click', logout);

      document.querySelectorAll('#productsTable th.sortable').forEach(th => {
        th.style.cursor = 'pointer';
        th.addEventListener('click', () => {
          const field = th.getAttribute('data-sort');
          if (currentSortField === field) {
            currentSortDir = currentSortDir === 'asc' ? 'desc' : 'asc';
          } else {
            currentSortField = field;
            currentSortDir = 'asc';
          }
          updateSortArrows();
          load();
        });
      });
    }

    async function handleSearchInput(e) {
      const v = e.target.value;
      currentSearch = v;
      currentProductId = undefined;
      currentPage = 1;
      if (searchTimeout) clearTimeout(searchTimeout);
      const dd = document.getElementById('prodDropdown');
      if (!v) { dd.style.display = 'none'; dd.innerHTML = ''; return; }
      
      searchTimeout = setTimeout(async () => {
        try {
          const [prodRes, supRes] = await Promise.all([
            authFetch('/api/products?search=' + encodeURIComponent(v)),
            authFetch('/api/suppliers')
          ]);
          const productData = await prodRes.json();
          const products = formUtils.extractItems(productData);
          const supplierData = await supRes.json();
          const suppliers = formUtils.extractItems(supplierData).filter(s => s.name.toLowerCase().includes(v.toLowerCase()));
          
          dd.innerHTML = '';

          products.forEach(p => {
            const el = document.createElement('div');
            el.textContent = p.name + ' [товар]';
            el.onclick = () => {
              currentProductId = p.id;
              document.getElementById('productSearch').value = p.name;
              dd.style.display = 'none';
              load();
            };
            dd.appendChild(el);
          });
          
          suppliers.forEach(s => {
            const el = document.createElement('div');
            el.textContent = s.name + ' [поставщик]';
            el.onclick = () => {
              currentProductId = undefined;
              currentSearch = '';
              document.getElementById('productSearch').value = s.name;
              dd.style.display = 'none';
              
              (async () => {
                try {
                  const productData = await (await authFetch('/api/products')).json();
                  const all = formUtils.extractItems(productData);
                  const q = s.name.toLowerCase();
                  const filtered = all.filter(p => {
                    // Prefer server-side aggregated suppliers list when available
                    if (Array.isArray(p.supplied) && p.supplied.length > 0) {
                      return p.supplied.some(sp => (sp.name || '').toLowerCase().includes(q));
                    }
                    // fallback to top-level supplierName
                    if (p.supplierName && p.supplierName.toLowerCase().includes(q)) return true;
                    // fallback to transaction-level supplier info
                    return (p.transactions || []).some(
                      t => t.type === 'in' && ((t.supplier && t.supplier.name && t.supplier.name.toLowerCase().includes(q)) ||
                                              (t.supplierName && t.supplierName.toLowerCase().includes(q)))
                    );
                  });
                  render(filtered);
                } catch (error) {
                  console.error('Error filtering by supplier:', error);
                  notify('Ошибка при фильтрации по поставщику', 'error');
                }
              })();
            };
            dd.appendChild(el);
          });
          
          dd.style.display = dd.innerHTML ? 'block' : 'none';
        } catch (error) {
          console.error('Search error:', error);
          notify('Ошибка при поиске', 'error');
        }
      }, 250);
    }

    async function fetchProducts() {
      try {
        if (currentProductId) {
          const res = await authFetch('/api/products');
          const data = await res.json();
          const all = formUtils.extractItems(data);
          return { items: all.filter(p => p.id === currentProductId), page: 1, limit: pageSize, total: 1 };
        }
        
        let url = '/api/products?page=' + currentPage + '&limit=' + pageSize;
        if (currentSearch) url += '&search=' + encodeURIComponent(currentSearch);
        
        const res = await authFetch(url);
        const data = await res.json();
        
        // Normalize response
        if (data.items && data.page && data.limit) {
          totalPages = Math.ceil(data.total / data.limit);
          return data;
        } else {
          const items = formUtils.extractItems(data);
          totalPages = Math.ceil(items.length / pageSize);
          return { items, page: currentPage, limit: pageSize, total: items.length };
        }
      } catch (error) {
        console.error('Error fetching products:', error);
        notify('Ошибка при загрузке товаров', 'error');
        return [];
      }
    }

    function updateSortArrows() {
      const arrows = {
        asc: '↑',
        desc: '↓',
        none: '↕'
      };
      const fields = ['id', 'name', 'supplier', 'quantity', 'unit'];
      fields.forEach(f => {
        const el = document.getElementById('sortArrow' + capitalize(f));
        if (!el) return;
        if (currentSortField === f) {
          el.textContent = arrows[currentSortDir];
        } else {
          el.textContent = arrows.none;
        }
      });
    }
    
    function capitalize(s) { return s.charAt(0).toUpperCase() + s.slice(1); }

    function getSupplierString(p) {
      if (!p) return '—'
      if (Array.isArray(p.supplied) && p.supplied.length > 0) {
        const names = p.supplied.map(s => s.name).filter(Boolean)
        if (names.length === 0) return '—'
        return names.join(', ')
      }

      if (p.supplierName) return p.supplierName
      if (p.supplier && p.supplier.name) return p.supplier.name
      const txs = Array.isArray(p.transactions) ? p.transactions : []
      for (let i = txs.length - 1; i >= 0; i--) {
        const t = txs[i]
        if (!t) continue
        if (t.type === 'in') {
          if (t.supplier && t.supplier.name) return t.supplier.name
          if (t.supplierName) return t.supplierName
        }
      }
      return '—'
    }

    function render(paginatedData){
      const products = formUtils.extractItems(paginatedData) || [];
      
      let sorted = products.slice();
      if (currentSortField) {
        sorted.sort((a, b) => {
          let va, vb;
          switch (currentSortField) {
            case 'id': va = a.id; vb = b.id; break;
            case 'name': va = (a.name || '').toLowerCase(); vb = (b.name || '').toLowerCase(); break;
            case 'supplier':
              va = getSupplierString(a).toLowerCase();
              vb = getSupplierString(b).toLowerCase();
              break;
            case 'quantity': va = a.quantity; vb = b.quantity; break;
            case 'unit': va = (a.unit || '').toLowerCase(); vb = (b.unit || '').toLowerCase(); break;
            default: va = 0; vb = 0;
          }
          if (va < vb) return currentSortDir === 'asc' ? -1 : 1;
          if (va > vb) return currentSortDir === 'asc' ? 1 : -1;
          return 0;
        });
      }
      
      const tbody = document.querySelector('#productsTable tbody')
      tbody.innerHTML = ''
      
      if (sorted.length === 0) {
        const tr = document.createElement('tr')
        tr.innerHTML = `<td colspan="7" style="text-align:center;color:#888">Нет товаров</td>`
        tbody.appendChild(tr)
        return
      }
      
      sorted.forEach(p => {
        const supplierDisplay = getSupplierString(p);
        const tr = document.createElement('tr')
        tr.innerHTML = `
          <td>${isWorker ? '' : `<input class="prod-select" type="checkbox" data-id="${p.id}">`}</td>
          <td>${p.id}</td>
          <td ${isWorker ? '' : `contenteditable="true" class="editable-cell" data-id="${p.id}" data-field="name" data-old-value="${escapeHtml(p.name || '')}"`}>${escapeHtml(p.name || '')}</td>
          <td>${escapeHtml(supplierDisplay)}</td>
          <td>${p.quantity}</td>
          <td ${isWorker ? '' : `contenteditable="true" class="editable-cell" data-id="${p.id}" data-field="unit" data-old-value="${escapeHtml(p.unit || '')}"`}>${escapeHtml(p.unit || '')}</td>
          <td>
            <div class="wk-flex wk-gap-1 wk-flex-wrap md:flex-nowrap">
              <button class="wk-btn wk-btn-primary wk-btn-sm w-full max-w-24" data-id="${p.id}" data-action="in">+ Приход</button>
              <button class="wk-btn wk-btn-secondary wk-btn-sm w-full max-w-24" data-id="${p.id}" data-action="out">- Расход</button>
              ${isWorker ? '' : `<button class="wk-btn wk-btn-danger wk-btn-sm w-full max-w-24" data-id="${p.id}" data-action="delete">Удалить</button>`}
            </div>
          </td>`;
        tbody.appendChild(tr);
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
      const selectAll = document.getElementById('selectAllProducts');
      if (selectAll) {
        selectAll.addEventListener('change', (e) => {
          const checked = (selectAll instanceof HTMLInputElement) ? selectAll.checked : false;
          document.querySelectorAll('#productsTable .prod-select').forEach((cb) => {
            if (cb instanceof HTMLInputElement) cb.checked = checked;
          });
        });
      }
 
      const bulkBtn = document.getElementById('bulkAdjustBtn');
      if (bulkBtn) {
        bulkBtn.addEventListener('click', async () => {
          try {
            const selected = Array.from(document.querySelectorAll('#productsTable .prod-select'))
              .filter(n => n.checked)
              .map(n => Number(n.getAttribute('data-id')));
            if (!selected.length) {
              notify('Выберите хотя бы один товар', 'error');
              return;
            }
 
            const [workers, destinations, suppliers, allProducts] = await Promise.all([
              authFetch('/api/workers').then(r => r.json()).then(d => formUtils.extractItems(d)).catch(()=>[]),
              authFetch('/api/locations').then(r => r.json()).then(d => formUtils.extractItems(d)).catch(()=>[]),
              authFetch('/api/suppliers').then(r => r.json()).then(d => formUtils.extractItems(d)).catch(()=>[]),
              authFetch('/api/products').then(r => r.json()).then(d => formUtils.extractItems(d)).catch(()=>[])
            ]);
 
            const modalRoot = document.getElementById('modalRoot');
            const map = {};
            (allProducts || []).forEach(p => { map[p.id] = p });
            const rowsHtml = selected.map(id => {
              const p = map[id];
              const name = p ? escapeHtml(p.name) : `#${id}`;
              const qty  = p ? p.quantity : '—';
              return `<div class="wk-form-group"><label>${name} (ост: ${qty})</label><input class="wk-form-input bulk-delta" data-id="${id}" type="number" step="1" min="1" value="1"></div>`;
            }).join('');
 
            modalRoot.innerHTML = `
              <div class="modal">
                <div class="modal-card">
                  <h3 class="wk-card-title wk-mb-4">Массовый приход/расход (${selected.length} шт.)</h3>
                  <form id="bulkForm" onsubmit="return false">
                    <div class="wk-form-group">
                      <label class="wk-form-label">Тип операции</label>
                      <select class="wk-form-input" name="type" id="bulkType">
                        <option value="in">Приход</option>
                        <option value="out">Расход</option>
                      </select>
                    </div>
                    ${rowsHtml}
                    <div id="bulkExtra" class="wk-form-group">
                      <!-- supplier / destination / worker will be injected here -->
                    </div>
                    <div class="wk-flex wk-gap-2 wk-justify-between">
                      <button type="button" id="cancelBulk" class="wk-btn wk-btn-secondary">Отмена</button>
                      <button type="submit" class="wk-btn wk-btn-primary">Выполнить</button>
                    </div>
                  </form>
                </div>
              </div>
            `;
 
            function renderBulkExtra(type) {
              const el = document.getElementById('bulkExtra');
              if (!el) return;
              
              if (type === 'in') {
                el.innerHTML = `
                  <label class="wk-form-label">Поставщик (необязательно)</label>
                  <div class="wk-flex wk-gap-2">
                    <select class="wk-form-input" name="supplierId" style="flex:1;">
                      <option value="">—</option>
                      ${suppliers.map(s => `<option value="${s.id}">${escapeHtml(s.name)}</option>`).join('')}
                    </select>
                    <button type="button" class="wk-btn wk-btn-secondary add-entity-btn" data-type="supplier" style="min-width: 40px;">+</button>
                  </div>
                `;
                
                // Setup callback for supplier addition in bulk modal
                const bulkAddSupplierBtn = el.querySelector('.add-entity-btn[data-type="supplier"]');
                if (bulkAddSupplierBtn) {
                  bulkAddSupplierBtn.onclick = (e) => {
                    e.preventDefault();
                    openAddEntityForm('supplier', (newSupplierId, updatedSuppliers) => {
                      // Use updated suppliers if provided, otherwise refresh
                      if (updatedSuppliers) {
                        suppliers = updatedSuppliers;
                      } else {
                        fetchSuppliers().then(updated => suppliers = updated);
                      }
                      renderBulkExtra('in');
                      // Auto-select the new supplier
                      setTimeout(() => {
                        const select = document.querySelector('select[name="supplierId"]');
                        if (select) {
                          select.value = String(newSupplierId);
                        }
                      }, 50);
                    });
                  };
                }
              } else {
                el.innerHTML = `
                  <label class="wk-form-label">Объект</label>
                  <select class="wk-form-input" name="destinationId">
                    <option value="">—</option>
                    ${destinations.map(d => `<option value="${d.id}">${escapeHtml(d.name)}</option>`).join('')}
                  </select>
                  <label class="wk-form-label wk-mt-2">Работник</label>
                  <select class="wk-form-input" name="workerId">
                    <option value="">—</option>
                    ${workers.map(w => `<option value="${w.id}">${escapeHtml(w.fullName)}</option>`).join('')}
                  </select>
                `;
              }
            }
  
            renderBulkExtra('in');
            document.getElementById('bulkType').addEventListener('change', (e) => {
              renderBulkExtra(e.target.value);
            });

            document.getElementById('cancelBulk').addEventListener('click', () => modalRoot.innerHTML = '');
  
            document.getElementById('bulkForm').addEventListener('submit', async (e) => {
              e.preventDefault();
              const form = e.target;

              await formUtils.disableDuring(form, async () => {
                const type = form.type.value;
                const payloadItems = Array.from(document.querySelectorAll('.bulk-delta')).map(el => ({
                  productId: Number(el.getAttribute('data-id')),
                  delta: Number(el.value)
                }));

                for (const it of payloadItems) {
                  if (!Number.isInteger(it.delta) || it.delta <= 0) {
                    notify('Каждое количество должно быть положительным целым числом', 'error');
                    return;
                  }
                }

                const extra = { type, items: payloadItems };
                if (type === 'in') {
                  extra.supplierId = form.supplierId.value ? Number(form.supplierId.value) : undefined;
                } else {
                  extra.destinationId = form.destinationId.value ? Number(form.destinationId.value) : undefined;
                  extra.workerId = form.workerId.value ? Number(form.workerId.value) : undefined;
                }

                try {
                  const resp = await authFetch('/api/transactions/bulk-adjust', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(extra)
                  });
                  if (!resp.ok) {
                    const j = await resp.json().catch(()=>({}));
                    throw new Error(j.error || 'Ошибка сервера');
                  }
                  modalRoot.innerHTML = '';
                  await load();
                  notify('Операция успешно выполнена', 'success');
                } catch (err) {
                  notify('Ошибка: ' + (err.message || err), 'error');
                }
              }, { text: 'Выполняется...' });
            });
          } catch (error) {
            console.error('Bulk adjustment error:', error);
            notify('Ошибка при массовой операции', 'error');
          }
        });
      }
    });
   
    async function openConfirmEditModal(id, field, oldVal, newVal, cellEl) {
      const modalRoot = document.getElementById('modalRoot')
      modalRoot.innerHTML = `
        <div class="modal">
          <div class="modal-card">
            <h3 class="wk-card-title wk-mb-4">Подтвердите изменение</h3>
            <p class="wk-mb-4">Поле: <strong>${field === 'name' ? 'Название' : 'Ед. изм.'}</strong></p>
            <p class="wk-mb-4">Старое: <em>${escapeHtml(oldVal)}</em></p>
            <p class="wk-mb-4">Новое: <em>${escapeHtml(newVal)}</em></p>
            <div class="wk-flex wk-gap-2 wk-justify-end">
              <button type="button" id="cancelEdit" class="wk-btn wk-btn-secondary">Отменить</button>
              <button type="button" id="confirmEdit" class="wk-btn wk-btn-primary">Сохранить</button>
            </div>
          </div>
        </div>
      `
      document.getElementById('cancelEdit').addEventListener('click', () => {
        modalRoot.innerHTML = ''
        cellEl.textContent = oldVal
      });
      document.getElementById('confirmEdit').addEventListener('click', async () => {
        try {
          const payload = { [field]: newVal }
          const resp = await authFetch('/api/products/' + id, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          })
          if (!resp.ok) {
            const j = await resp.json().catch(()=>({}))
            throw new Error(j.error || 'Ошибка сервера')
          }
          modalRoot.innerHTML = ''
          await load() 
        } catch (err) {
          notify('Ошибка: ' + (err.message || err), 'error')
          modalRoot.innerHTML = ''
          cellEl.textContent = oldVal
        }
      });
    }

    async function openAdjustModal(productId, type) {
      try {
        const [workers, destinations] = await Promise.all([
          authFetch('/api/workers').then(r => r.json()).then(d => formUtils.extractItems(d)),
          authFetch('/api/locations').then(r => r.json()).then(d => formUtils.extractItems(d))
        ]);
        const modalRoot = document.getElementById('modalRoot');

        if (type === 'in') {
          const supplierData = await authFetch('/api/suppliers').then(r => r.json());
          let suppliers = formUtils.extractItems(supplierData);
          
          const inModal = document.createElement('div');
          inModal.className = 'modal';
          inModal.setAttribute('data-modal', 'adjust-in');
          
          function renderContent() {
            inModal.innerHTML = `
              <div class="modal-card">
                <h3 class="wk-card-title wk-mb-4">Приход товара #${productId}</h3>
                <form id="adjFormIn" onsubmit="return false">
                  <div class="wk-form-group">
                    <label class="wk-form-label">Количество</label>
                    <input class="wk-form-input" name="delta" type="number" step="1" min="1" required>
                  </div>
                  <div class="wk-form-group">
                    <label class="wk-form-label">Поставщик</label>
                    <div class="wk-flex wk-gap-2">
                      <select class="wk-form-input" name="supplierId" style="flex: 1;">
                        <option value="">—</option>
                        ${suppliers.map(s => `<option value="${s.id}">${escapeHtml(s.name)}</option>`).join('')}
                      </select>
                      <button type="button" class="wk-btn wk-btn-secondary add-entity-btn" data-type="supplier">+</button>
                    </div>
                  </div>
                  <div class="wk-flex wk-gap-2 wk-justify-between">
                    <button type="button" id="cancelBtnIn" class="wk-btn wk-btn-secondary">Отмена</button>
                    <button type="submit" class="wk-btn wk-btn-primary">Подтвердить</button>
                  </div>
                </form>
              </div>
            `;
          }
          
          renderContent();
          modalRoot.appendChild(inModal);
          setupModalBackdropHandler(inModal, null);
          
          // Single delegation handler for all clicks in this modal
          inModal.addEventListener('click', (e) => {
            if (e.target.id === 'cancelBtnIn') {
              inModal.remove();
            } else if (e.target.classList.contains('add-entity-btn') && e.target.getAttribute('data-type') === 'supplier') {
              e.preventDefault();
              openAddEntityForm('supplier', async (newSupplierId) => {
                const updated = formUtils.extractItems(await authFetch('/api/suppliers').then(r => r.json()));
                const select = inModal.querySelector('select[name="supplierId"]');
                if (select) {
                  select.innerHTML = `
                    <option value="">—</option>
                    ${updated.map(s => `<option value="${s.id}">${escapeHtml(s.name)}</option>`).join('')}
                  `;
                }
              });
            }
          });
          
          // Form submit handler
          inModal.addEventListener('submit', async (e) => {
            if (e.target.id !== 'adjFormIn') return;
            e.preventDefault();
            const form = e.target;

            await formUtils.disableDuring(form, async () => {
              const raw = Number(form.delta.value);
              if (!Number.isInteger(raw) || raw <= 0) { 
                notify('Нужно целое положительное число', 'error'); 
                return; 
              }
              
              const data = {
                delta: raw,
                type: 'in',
                supplierId: form.supplierId.value ? Number(form.supplierId.value) : undefined
              };
              
              const resp = await authFetch(`/api/products/${productId}/adjust`, {
                method: 'POST',
                headers: { 'content-type': 'application/json' },
                body: JSON.stringify(data)
              });
              
              const json = await resp.json().catch(() => ({}));
              if (!resp.ok) {
                notify('Ошибка: ' + (json.error || JSON.stringify(json)), 'error');
              } else {
                inModal.remove();
                load();
              }
            }, { text: 'Подтверждение...' });
          });
          
          return;
        }

        const outModal = document.createElement('div');
        outModal.className = 'modal';
        
        outModal.innerHTML = `
          <div class="modal-card">
            <h3 class="wk-card-title wk-mb-4">Расход товара #${productId}</h3>
            <form id="adjFormOut" onsubmit="return false">
              <div class="wk-form-group">
                <label class="wk-form-label">Количество</label>
                <input class="wk-form-input" name="delta" type="number" step="1" min="1" required>
              </div>
              <div class="wk-form-group">
                <label class="wk-form-label">Куда (объект)</label>
                <div class="wk-flex wk-gap-2">
                  <select class="wk-form-input" name="destinationId" required style="flex: 1;">
                    <option value="">Выберите объект</option>
                    ${destinations.map(d => `<option value="${d.id}">${escapeHtml(d.name)}</option>`).join('')}
                  </select>
                  <button type="button" class="wk-btn wk-btn-secondary add-entity-btn" data-type="destination">+</button>
                </div>
              </div>
              <div class="wk-form-group">
                <label class="wk-form-label">Кому (работник)</label>
                <select class="wk-form-input" name="workerId" required>
                  <option value="">Выберите работника</option>
                  ${workers.map(w => `<option value="${w.id}">${escapeHtml(w.fullName)}</option>`).join('')}
                </select>
              </div>
              <div class="wk-flex wk-gap-2 wk-justify-between">
                <button type="button" id="cancelBtnOut" class="wk-btn wk-btn-secondary">Отмена</button>
                <button type="submit" class="wk-btn wk-btn-primary">Подтвердить</button>
              </div>
            </form>
          </div>
        `;
        
        modalRoot.appendChild(outModal);
        setupModalBackdropHandler(outModal, null);
        
        // Single delegation handler for all clicks in this modal
        outModal.addEventListener('click', (e) => {
          if (e.target.id === 'cancelBtnOut') {
            outModal.remove();
          } else if (e.target.classList.contains('add-entity-btn') && e.target.getAttribute('data-type') === 'destination') {
            e.preventDefault();
            openAddEntityForm('destination', async (newDestId) => {
              const updated = formUtils.extractItems(await authFetch('/api/locations').then(r => r.json()));
              const select = outModal.querySelector('select[name="destinationId"]');
              if (select) {
                select.innerHTML = `
                  <option value="">Выберите объект</option>
                  ${updated.map(d => `<option value="${d.id}">${escapeHtml(d.name)}</option>`).join('')}
                `;
              }
            });
          }
        });
        
        // Form submit handler
        outModal.addEventListener('submit', async (e) => {
          if (e.target.id !== 'adjFormOut') return;
          e.preventDefault();
          const form = e.target;

          await formUtils.disableDuring(form, async () => {
            const raw = Number(form.delta.value);
            if (!Number.isInteger(raw) || raw <= 0) { 
              notify('Нужно целое положительное число', 'error'); 
              return; 
            }
            
            if (!form.workerId.value) { 
              notify('Выберите работника', 'error'); 
              return; 
            }
            
            const data = {
              delta: raw,
              type: 'out',
              destinationId: Number(form.destinationId.value),
              workerId: Number(form.workerId.value)
            };
            
            const resp = await authFetch(`/api/products/${productId}/adjust`, {
              method: 'POST',
              headers: { 'content-type': 'application/json' },
              body: JSON.stringify(data)
            });
            
            const json = await resp.json().catch(() => ({}));
            if (!resp.ok) {
              notify('Ошибка: ' + (json.error || JSON.stringify(json)), 'error');
            } else {
              outModal.remove();
              load();
            }
          }, { text: 'Подтверждение...' });
        })
      } catch (error) {
        console.error('Error opening adjust modal:', error);
        notify('Ошибка при открытии формы операции', 'error');
      }
    }

    async function openAddEntityForm(type, onSuccess) {
      const modalRoot = document.getElementById('modalRoot');
      
      if (type === 'supplier') {
        const childModal = document.createElement('div');
        childModal.className = 'modal';
        childModal.innerHTML = `
          <div class="modal-card">
            <h3 class="wk-card-title wk-mb-4">Добавить поставщика</h3>
            <div class="wk-form-group">
              <label class="wk-form-label">Название</label>
              <input id="supplier-name" type="text" class="wk-form-input" required>
            </div>
            <div class="wk-form-group">
              <label class="wk-form-label">Телефон</label>
              <input id="supplier-phone" type="text" class="wk-form-input">
            </div>
            <div class="wk-form-group">
              <label class="wk-form-label">Email</label>
              <input id="supplier-email" type="email" class="wk-form-input">
            </div>
            <div class="wk-flex wk-gap-2 wk-justify-between">
              <button type="button" id="supplier-cancel" class="wk-btn wk-btn-secondary">Отмена</button>
              <button type="button" id="supplier-save" class="wk-btn wk-btn-primary">Сохранить</button>
            </div>
          </div>
        `;
        
        modalRoot.appendChild(childModal);
        
        // Query within the child modal, not the document
        const cancelBtn = childModal.querySelector('#supplier-cancel');
        const saveBtn = childModal.querySelector('#supplier-save');
        const nameInput = childModal.querySelector('#supplier-name');
        const phoneInput = childModal.querySelector('#supplier-phone');
        const emailInput = childModal.querySelector('#supplier-email');
        
        cancelBtn.onclick = () => {
          childModal.remove();
        };
        
        saveBtn.onclick = async () => {
          const name = nameInput.value.trim();
          const phone = phoneInput.value.trim();
          const email = emailInput.value.trim();
          
          if (!name) {
            notify('Введите название', 'error');
            return;
          }
          
          saveBtn.disabled = true;
          
          try {
            const res = await authFetch('/api/suppliers', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ name, phone, email })
            });
            
            if (!res.ok) {
              const err = await res.json().catch(() => ({}));
              notify(err.error || 'Ошибка', 'error');
              saveBtn.disabled = false;
              return;
            }
            
            const newSupplier = await res.json();
            
            childModal.remove();
            notify('Поставщик добавлен', 'success');
            
            if (onSuccess) onSuccess(newSupplier.id);
          } catch (e) {
            notify(e.message || 'Ошибка', 'error');
            saveBtn.disabled = false;
          }
        };
        
      } else if (type === 'destination') {
        const childModal = document.createElement('div');
        childModal.className = 'modal';
        childModal.innerHTML = `
          <div class="modal-card">
            <h3 class="wk-card-title wk-mb-4">Добавить объект</h3>
            <div class="wk-form-group">
              <label class="wk-form-label">Название</label>
              <input id="dest-name" type="text" class="wk-form-input" required>
            </div>
            <div class="wk-form-group">
              <label class="wk-form-label">Город</label>
              <input id="dest-city" type="text" class="wk-form-input">
            </div>
            <div class="wk-form-group">
              <label class="wk-form-label">Район</label>
              <input id="dest-district" type="text" class="wk-form-input">
            </div>
            <div class="wk-form-group">
              <label class="wk-form-label">Адрес</label>
              <input id="dest-address" type="text" class="wk-form-input">
            </div>
            <div class="wk-flex wk-gap-2 wk-justify-between">
              <button type="button" id="dest-cancel" class="wk-btn wk-btn-secondary">Отмена</button>
              <button type="button" id="dest-save" class="wk-btn wk-btn-primary">Сохранить</button>
            </div>
          </div>
        `;
        
        modalRoot.appendChild(childModal);
        
        // Query within the child modal, not the document
        const cancelBtn = childModal.querySelector('#dest-cancel');
        const saveBtn = childModal.querySelector('#dest-save');
        const nameInput = childModal.querySelector('#dest-name');
        const cityInput = childModal.querySelector('#dest-city');
        const districtInput = childModal.querySelector('#dest-district');
        const addressInput = childModal.querySelector('#dest-address');
        
        cancelBtn.onclick = () => {
          childModal.remove();
        };
        
        saveBtn.onclick = async () => {
          const name = nameInput.value.trim();
          const city = cityInput.value.trim();
          const district = districtInput.value.trim();
          const address = addressInput.value.trim();
          
          if (!name) {
            notify('Введите название', 'error');
            return;
          }
          
          saveBtn.disabled = true;
          
          try {
            const res = await authFetch('/api/locations', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ name, city, district, address })
            });
            
            if (!res.ok) {
              const err = await res.json().catch(() => ({}));
              notify(err.error || 'Ошибка', 'error');
              saveBtn.disabled = false;
              return;
            }
            
            const newDest = await res.json();
            childModal.remove();
            notify('Объект добавлен', 'success');
            
            if (onSuccess) onSuccess(newDest.id);
          } catch (e) {
            notify(e.message || 'Ошибка', 'error');
            saveBtn.disabled = false;
          }
        };
      }
    }

    async function openDeleteModal(productId) {
      const modalRoot = document.getElementById('modalRoot');
      modalRoot.innerHTML = `
        <div class="modal">
          <div class="modal-card">
            <h3 class="wk-card-title wk-mb-4">Удалить товар #${productId}?</h3>
            <p class="wk-text-muted wk-mb-4">По умолчанию проводки останутся в истории.</p>
            <div class="wk-form-group">
              <label class="wk-flex wk-items-center wk-gap-2">
                <input type="checkbox" id="purgeTx">
                <span>Удалить проводки</span>
              </label>
            </div>
            <div class="wk-flex wk-gap-2 wk-justify-between">
              <button type="button" id="cancelDel" class="wk-btn wk-btn-secondary">Отмена</button>
              <button type="button" id="confirmDelete" class="wk-btn wk-btn-danger">Удалить</button>
            </div>
          </div>
        </div>
      `;
      
      document.getElementById('cancelDel').addEventListener('click', () => modalRoot.innerHTML = '');
      document.getElementById('confirmDelete').addEventListener('click', async () => {
        try {
          const purge = document.getElementById('purgeTx').checked;
          const resp = await authFetch(`/api/products/${productId}?purge=${purge ? 'true' : 'false'}`, { 
            method: 'DELETE' 
          });
          
          const json = await resp.json();
          if (!resp.ok) {
            notify('Ошибка при удалении: ' + (json.error || JSON.stringify(json)), 'error');
          } else {
            modalRoot.innerHTML = '';
            load();
          }
        } catch (error) {
          console.error('Error deleting product:', error);
          notify('Ошибка при удалении товара', 'error');
        }
      });
    }

    async function openCreateProductModal() {
      try {
        const modalRoot = document.getElementById('modalRoot');
        const productData = await authFetch('/api/products').then(r => r.json());
        const allProducts = formUtils.extractItems(productData);
        let suppliers = formUtils.extractItems(await authFetch('/api/suppliers').then(r => r.json()));

        let itemCount = 1;
        
        // Create persistent modal container
        const createModal = document.createElement('div');
        createModal.className = 'modal';
        modalRoot.appendChild(createModal);

        function renderForm() {
          const itemsHtml = Array.from({ length: itemCount }, (_, i) => `
            <div class="wk-card wk-mb-3 product-item" style="background: #f9fafb;" data-idx="${i}">
              <div class="wk-flex wk-justify-between wk-items-start wk-mb-2">
                <div class="wk-text-sm wk-font-semibold">Товар ${i + 1}</div>
                <button type="button" class="delete-product-btn text-red-500 hover:text-red-700 font-bold" data-idx="${i}" style="font-size: 1.2em; line-height: 1; padding: 0; border: none; background: none; cursor: pointer;">✕</button>
              </div>
              <div class="wk-form-group">
                <label class="wk-form-label">Название</label>
                <input class="wk-form-input product-name" data-idx="${i}" required>
              </div>
              <div class="wk-flex wk-gap-2">
                <div class="wk-form-group" style="flex: 1;">
                  <label class="wk-form-label">Ед.изм</label>
                  <input class="wk-form-input product-unit" data-idx="${i}" value="шт">
                </div>
                <div class="wk-form-group" style="flex: 1;">
                  <label class="wk-form-label">Остаток</label>
                  <input class="wk-form-input product-qty" data-idx="${i}" type="number" step="1" min="0" max="65535" value="0" required>
                </div>
              </div>
              <div class="wk-form-group">
                <label class="wk-form-label">Поставщик (необязательно)</label>
                <div class="wk-flex wk-gap-2">
                  <select class="wk-form-input product-supplier" data-idx="${i}" style="flex: 1;">
                    <option value="">—</option>
                    ${suppliers.map(s => `<option value="${s.id}">${escapeHtml(s.name)}</option>`).join('')}
                  </select>
                  <button type="button" class="wk-btn wk-btn-secondary add-entity-btn" data-type="supplier" data-idx="${i}" style="min-width: 40px;">+</button>
                </div>
              </div>
            </div>
          `).join('');

          createModal.innerHTML = `
            <div class="modal-card">
              <h3 class="wk-card-title wk-mb-4">Создать товары (${itemCount})</h3>
              <form id="createForm" onsubmit="return false">
                ${itemsHtml}
                
                <div id="createError" class="wk-alert wk-alert-error hidden"></div>
                <div id="createSpinner" class="wk-loading hidden">
                  <span class="wk-loading-spinner"></span>
                  Сохранение...
                </div>
                
                <div class="wk-flex wk-gap-2 wk-justify-between wk-flex-wrap">
                  <button type="button" id="cancel2" class="wk-btn wk-btn-secondary">Отмена</button>
                  <div class="wk-flex wk-gap-2">
                    <button type="button" id="addMoreBtn" class="wk-btn wk-btn-secondary">+ Добавить ещё</button>
                    <button type="submit" class="wk-btn wk-btn-primary">Создать</button>
                  </div>
                </div>
              </form>
            </div>
          `;
        }
        
        renderForm();

        // Use event delegation on the persistent modal container
        createModal.addEventListener('click', (e) => {
          if (e.target.id === 'cancel2') {
            createModal.remove();
          } else if (e.target.id === 'addMoreBtn') {
            e.preventDefault();
            const form = createModal.querySelector('#createForm');
            const i = itemCount;
            itemCount++;
            const div = document.createElement('div');
            div.className = 'wk-card wk-mb-3 product-item';
            div.style.background = '#f9fafb';
            div.setAttribute('data-idx', i);
            div.innerHTML = `
              <div class="wk-flex wk-justify-between wk-items-start wk-mb-2">
                <div class="wk-text-sm wk-font-semibold">Товар ${i + 1}</div>
                <button type="button" class="delete-product-btn text-red-500 hover:text-red-700 font-bold" data-idx="${i}" style="font-size: 1.2em; line-height: 1; padding: 0; border: none; background: none; cursor: pointer;">✕</button>
              </div>
              <div class="wk-form-group">
                <label class="wk-form-label">Название</label>
                <input class="wk-form-input product-name" data-idx="${i}" required>
              </div>
              <div class="wk-flex wk-gap-2">
                <div class="wk-form-group" style="flex: 1;">
                  <label class="wk-form-label">Ед.изм</label>
                  <input class="wk-form-input product-unit" data-idx="${i}" value="шт">
                </div>
                <div class="wk-form-group" style="flex: 1;">
                  <label class="wk-form-label">Остаток</label>
                  <input class="wk-form-input product-qty" data-idx="${i}" type="number" step="1" min="0" max="65535" value="0" required>
                </div>
              </div>
              <div class="wk-form-group">
                <label class="wk-form-label">Поставщик (необязательно)</label>
                <div class="wk-flex wk-gap-2">
                  <select class="wk-form-input product-supplier" data-idx="${i}" style="flex: 1;">
                    <option value="">—</option>
                    ${suppliers.map(s => `<option value="${s.id}">${escapeHtml(s.name)}</option>`).join('')}
                  </select>
                  <button type="button" class="wk-btn wk-btn-secondary add-entity-btn" data-type="supplier" data-idx="${i}" style="min-width: 40px;">+</button>
                </div>
              </div>
            `;
            const errorEl = form.querySelector('#createError');
            form.insertBefore(div, errorEl);
          } else if (e.target.classList.contains('delete-product-btn')) {
            e.preventDefault();
            const idx = e.target.getAttribute('data-idx');
            const itemDiv = createModal.querySelector(`.product-item[data-idx="${idx}"]`);
            if (itemDiv) itemDiv.remove();
          } else if (e.target.classList.contains('add-entity-btn') && e.target.getAttribute('data-type') === 'supplier') {
            e.preventDefault();
            const itemIdx = e.target.getAttribute('data-idx');
            openAddEntityForm('supplier', async (newSupplierId) => {
              const updated = formUtils.extractItems(await authFetch('/api/suppliers').then(r => r.json()));
              const targetSelect = createModal.querySelector(`.product-supplier[data-idx="${itemIdx}"]`);
              if (targetSelect) {
                targetSelect.innerHTML = `
                  <option value="">—</option>
                  ${updated.map(s => `<option value="${s.id}">${escapeHtml(s.name)}</option>`).join('')}
                `;
              }
            });
          }
        });
        
        // Form submit handler
        createModal.addEventListener('submit', async (e) => {
          if (e.target.id !== 'createForm') return;
          e.preventDefault();
          
          const form = e.target;
          const errorDiv = createModal.querySelector('#createError');
          const spinnerDiv = createModal.querySelector('#createSpinner');
          
          errorDiv.textContent = '';
          errorDiv.classList.add('hidden');
          
          await formUtils.disableDuring(form, async () => {
            spinnerDiv.classList.remove('hidden');
            try {
              const items = [];
              document.querySelectorAll('.product-item').forEach((item, idx) => {
                const nameInput = item.querySelector('.product-name');
                const unitInput = item.querySelector('.product-unit');
                const qtyInput = item.querySelector('.product-qty');
                const suppInput = item.querySelector('.product-supplier');

                const name = nameInput.value.trim();
                const unit = unitInput.value.trim();
                const quantity = Number(qtyInput.value);
                const supplierId = suppInput.value;

                if (!name) {
                  throw new Error(`Товар ${idx + 1}: название обязательно`);
                }

                if (!Number.isInteger(quantity) || quantity < 0) {
                  throw new Error(`Товар ${idx + 1}: остаток должен быть целым числом >= 0`);
                }

                if (quantity > 65535) {
                  throw new Error(`Товар ${idx + 1}: максимум 65535`);
                }

                items.push({ name, unit, quantity, supplierId: supplierId ? Number(supplierId) : undefined });
              });

              for (const item of items) {
                const response = await authFetch('/api/products', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify(item)
                });

                if (!response.ok) {
                  const errorData = await response.json().catch(() => ({ error: 'Ошибка' }));
                  throw new Error(errorData.error || `Ошибка: ${response.status}`);
                }
              }

              createModal.remove();
              await load();
              notify(`${items.length} товаров созданы успешно`, 'success');
            } catch (error) {
              errorDiv.textContent = error.message || 'Произошла ошибка';
              errorDiv.classList.remove('hidden');
            } finally {
              spinnerDiv.classList.add('hidden');
            }
          }, { text: 'Сохранение...' });
        });
      } catch (error) {
        console.error('Error opening create modal:', error);
        notify('Ошибка при открытии формы создания', 'error');
      }
    }

    async function loadStats() {
      try {
        // Load stats and recent transactions with defensive JSON parsing.
        const statsResp = await authFetch('/api/stats').catch(err => { throw err });
        if (!statsResp.ok) {
          throw new Error('failed to load stats: ' + statsResp.status)
        }
        const statsCt = (statsResp.headers.get('content-type') || '')
        let stats
        if (statsCt.includes('application/json')) {
          stats = await statsResp.json()
        } else {
          const txt = await statsResp.text().catch(()=>null)
          console.error('stats endpoint returned non-json:', txt)
          throw new Error('stats endpoint returned non-JSON response')
        }

        const recentResp = await authFetch('/api/transactions/recent').catch(err => { throw err });
        let recent = []
        if (recentResp && recentResp.ok) {
          const recentCt = (recentResp.headers.get('content-type') || '')
          if (recentCt.includes('application/json')) {
            recent = await recentResp.json()
          } else {
            console.warn('recent transactions endpoint returned non-json; using empty list')
            recent = []
          }
        }

        document.getElementById('totalProducts').textContent = String(stats.totalProducts || 0);
        document.getElementById('todayTransactions').textContent = String(stats.todayTransactions || 0);
        document.getElementById('lastActivity').textContent = stats.lastActivity ? 
          formatDate(stats.lastActivity) : '—';

        const tbody = document.getElementById('recentTransactionsTable').querySelector('tbody');
        tbody.innerHTML = '';

        function txGroupKey(it) {
          const dateIso = it.date ? new Date(it.date).toISOString().slice(0, 19) : '';
          return `${dateIso}|${it.type||''}|s:${it.supplierId||''}|d:${it.destinationId||''}|w:${it.workerId||''}|n:${it.note||''}`;
        }

        const grouped = {};
        (recent || []).forEach((it) => {
          const key = txGroupKey(it);
          if (!grouped[key]) {
            grouped[key] = {
              ids: [],
              date: it.date,
              type: it.type,
              who: it.type === 'in'
                ? (it.supplier?.name || it.supplierName || '—')
                : (it.destination?.name || it.destinationName || '—'),
              authorUsername: it.authorUsername,
              totalDelta: 0,
              productMap: {}
            };
          }
          grouped[key].ids.push(it.id);
          const qty = Math.abs(it.delta || 0);
          grouped[key].totalDelta += qty;
          const prodName = (it.product && it.product.name) || it.productName || '—';
          grouped[key].productMap[prodName] = (grouped[key].productMap[prodName] || 0) + qty;
        });
 
        Object.values(grouped).forEach((g) => {
          const tr = document.createElement('tr');
          const productsArr = Object.keys(g.productMap || {}).map(name => `${name}(${g.productMap[name]})`);
          const productDisplay = productsArr.join(', ');
          tr.innerHTML = `
            <td>${formatDate(g.date)}</td>
            <td>${productDisplay}</td>
            <td>${g.totalDelta}</td>
            <td class="type ${g.type}">${g.type}</td>
            <td>${g.who}</td>
            <td>${g.authorUsername ? `@${escapeHtml(g.authorUsername)}` : '—'}</td>
          `;
          tbody.appendChild(tr);
        });
      } catch (error) {
        console.error('Error loading stats:', error);
        notify('Ошибка при загрузке статистики', 'error');
      }
    }

    async function load() {
      try {
        // refresh role in case it changed
        await applyWorkerRestrictions();
        const [products] = await Promise.all([
          fetchProducts(),
          loadStats()
        ]);
        render(products);
        updateSortArrows();
        
        // Render pagination controls
        renderPaginationControls();
      } catch (error) {
        console.error('Error loading data:', error);
        notify('Ошибка при загрузке данных', 'error');
      }
    }

    function renderPaginationControls() {
      // Top-right pagination
      let topPagination = document.getElementById('pagination-top');
      if (!topPagination) {
        topPagination = document.createElement('div');
        topPagination.id = 'pagination-top';
        const tableCard = document.querySelector('.wk-card:has(#productsTable)');
        tableCard.insertBefore(topPagination, tableCard.querySelector('.table-container'));
      } else {
        topPagination.innerHTML = '';
      }
      topPagination.appendChild(formUtils.createPaginationControls({
        currentPage,
        totalPages,
        onPageChange: (page) => { currentPage = page; load(); },
        position: 'top-right',
        id: 'pagination-top-controls'
      }));
      
      // Bottom-center pagination
      let bottomPagination = document.getElementById('pagination-bottom');
      if (!bottomPagination) {
        bottomPagination = document.createElement('div');
        bottomPagination.id = 'pagination-bottom';
        const tableCard = document.querySelector('.wk-card:has(#productsTable)');
        tableCard.appendChild(bottomPagination);
      } else {
        bottomPagination.innerHTML = '';
      }
      bottomPagination.appendChild(formUtils.createPaginationControls({
        currentPage,
        totalPages,
        onPageChange: (page) => { currentPage = page; load(); },
        position: 'bottom-center',
        id: 'pagination-bottom-controls'
      }));
    }

    function escapeHtml(text) {
      if (text === null || text === undefined) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
  </script>
</body>
</html>







