<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–û–±—ä–µ–∫—Ç—ã</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="styles/ui-kit.css">
  <link rel="stylesheet" href="styles/pages/destinations.css">
</head>
<body class="wk-base wk-p-4 md:wk-p-6">
  <div class="wk-container">
    
    <header class="wk-page-header flex flex-row justify-between">
      <div>
        <h1 class="wk-page-title">–û–±—ä–µ–∫—Ç—ã</h1>
      </div>
      <button id="logoutBtn" class="wk-btn wk-btn-outline wk-flex wk-items-center wk-gap-2">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
        </svg>
        –í—ã–π—Ç–∏
      </button>
    </header>

    <div class="wk-card wk-mb-6">
      <div class="wk-flex wk-flex-col wk-gap-4 flex-wrap">
        <nav class="wk-nav">
          <a class="wk-nav-item" href="index.html">–°–∫–ª–∞–¥</a>
          <a class="wk-nav-item" href="transactions.html">–ü—Ä–æ–≤–æ–¥–∫–∏</a>
          <a class="wk-nav-item" href="reports.html">–û—Ç—á—ë—Ç—ã</a>
          <a class="wk-nav-item" href="workers.html">–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏</a>
          <a class="wk-nav-item" href="suppliers.html">–ü–æ—Å—Ç–∞–≤—â–∏–∫–∏</a>
          <a class="wk-nav-item active" href="destinations.html">–û–±—ä–µ–∫—Ç—ã</a>
          <a class="wk-nav-item" href="tools.html">–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã</a>
        </nav>
        
        <button id="addBtn" class="wk-btn wk-btn-primary">
          –î–æ–±–∞–≤–∏—Ç—å –æ–±—ä–µ–∫—Ç
        </button>
      </div>
    </div>

    <div id="loading" class="wk-loading wk-justify-center wk-mb-6 hidden">
      <span class="wk-loading-spinner"></span>
      –ó–∞–≥—Ä—É–∑–∫–∞ –æ–±—ä–µ–∫—Ç–æ–≤...
    </div>

    <div id="list"class="wk-grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 wk-gap-4">
    </div>

    <div id="emptyState" class="empty-state hidden">
      <div class="empty-state-icon">üè¢</div>
      <h3 class="wk-text-lg wk-font-semibold wk-mb-2">–ù–µ—Ç –æ–±—ä–µ–∫—Ç–æ–≤</h3>
      <p class="wk-text-muted wk-mb-4">–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—ã–π –æ–±—ä–µ–∫—Ç, –Ω–∞–∂–∞–≤ –Ω–∞ –∫–Ω–æ–ø–∫—É –≤—ã—à–µ</p>
      <button id="addFirstBtn" class="wk-btn wk-btn-primary">–î–æ–±–∞–≤–∏—Ç—å –æ–±—ä–µ–∫—Ç</button>
    </div>

    <div id="modalRoot"></div>
  </div>

  <script src="auth.js"></script>
  <script>
    let locations = [];

    document.addEventListener('DOMContentLoaded', () => {
      setupEventListeners();
      load();
    });

    function setupEventListeners() {
      document.getElementById('addBtn').addEventListener('click', openAddModal);
      document.getElementById('addFirstBtn').addEventListener('click', openAddModal);
      document.getElementById('logoutBtn').addEventListener('click', logout);
    }

    async function fetchLocations() {
      try {
        showLoading(true);
        const response = await authFetch('/api/locations');
        if (!response.ok) {
          throw new Error(`–û—à–∏–±–∫–∞ HTTP! –°—Ç–∞—Ç—É—Å: ${response.status}`);
        }
        return await response.json();
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –æ–±—ä–µ–∫—Ç–æ–≤:', error);
        showError('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ –æ–±—ä–µ–∫—Ç–æ–≤');
        return [];
      } finally {
        showLoading(false);
      }
    }

    function showLoading(show) {
      const loadingEl = document.getElementById('loading');
      const listEl = document.getElementById('list');
      const emptyStateEl = document.getElementById('emptyState');
      
      loadingEl.classList.toggle('hidden', !show);
      
      if (show) {
        listEl.classList.add('hidden');
        emptyStateEl.classList.add('hidden');
      }
    }

    function showError(message) {
      let errorEl = document.getElementById('errorNotification');
      if (!errorEl) {
        errorEl = document.createElement('div');
        errorEl.id = 'errorNotification';
        errorEl.className = 'wk-alert wk-alert-error';
        document.querySelector('.wk-container').prepend(errorEl);
      }
      
      errorEl.textContent = message;
      
      setTimeout(() => {
        if (errorEl && errorEl.parentNode) {
          errorEl.remove();
        }
      }, 5000);
    }

    function renderLocations(locationsList) {
      const root = document.getElementById('list');
      const emptyStateEl = document.getElementById('emptyState');
      
      const activeLocations = locationsList.filter(location => !location.deleted);
      
      if (activeLocations.length === 0) {
        root.classList.add('hidden');
        emptyStateEl.classList.remove('hidden');
        return;
      }
      
      root.classList.remove('hidden');
      emptyStateEl.classList.add('hidden');
      root.innerHTML = '';
      
      activeLocations.forEach(location => {
        const div = document.createElement('div');
        div.className = 'wk-card flex flex-col gap-2';
        
        div.innerHTML = `
          <div class="wk-flex wk-items-center wk-justify-between wk-mb-3">
            <div class="wk-font-semibold wk-text-lg">${escapeHtml(location.name)}</div>
            <div class="wk-flex wk-items-center wk-gap-2">
              <span class="wk-badge wk-badge-primary">#${location.id}</span>
              <button class="wk-text-muted hover:wk-text-blue-600 edit-location" 
                      data-id="${location.id}" 
                      aria-label="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –æ–±—ä–µ–∫—Ç" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5h6M4 7v10a2 2 0 002 2h10l4-4V7a2 2 0 00-2-2H6a2 2 0 00-2 2z"/>
                </svg>
              </button>
              <button class="wk-text-muted hover:wk-text-red-600 delete-location" 
                      data-id="${location.id}" 
                      aria-label="–£–¥–∞–ª–∏—Ç—å –æ–±—ä–µ–∫—Ç" title="–£–¥–∞–ª–∏—Ç—å">
                 <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                   <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                 </svg>
               </button>
            </div>
          </div>
          
          <div class="wk-space-y-2">
            <div class="wk-flex wk-items-center wk-text-sm wk-text-muted">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 wk-mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
              </svg>
              <span>${location.city ? escapeHtml(location.city) : '–ù–µ —É–∫–∞–∑–∞–Ω'}</span>
            </div>
            
            <div class="wk-flex wk-items-center wk-text-sm wk-text-muted">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 wk-mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-4m-6 0H5m2 0h4M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
              </svg>
              <span>${location.district ? escapeHtml(location.district) : '–ù–µ —É–∫–∞–∑–∞–Ω'}</span>
            </div>
            
            <div class="wk-flex wk-items-start wk-text-sm wk-text-muted">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 wk-mr-2 wk-mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
              </svg>
              <span>${location.address ? escapeHtml(location.address) : '–ê–¥—Ä–µ—Å –Ω–µ —É–∫–∞–∑–∞–Ω'}</span>
            </div>
          </div>
        `;
        
        const deleteBtn = div.querySelector('button');
        const editBtn = div.querySelector('.edit-location');
        const delBtn = div.querySelector('.delete-location');
        if (editBtn) editBtn.addEventListener('click', () => openEditLocationModal(location));
        if (delBtn) delBtn.addEventListener('click', () => openDeleteModal(location));
        
        root.appendChild(div);
      });
    }

    function openDeleteModal(location) {
      const modalRoot = document.getElementById('modalRoot');
      modalRoot.innerHTML = `
        <div class="modal">
          <div class="modal-card">
            <h3 class="wk-card-title wk-mb-4">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è</h3>
            <p class="wk-text-muted wk-mb-6">
              –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –æ–±—ä–µ–∫—Ç <strong>${escapeHtml(location.name)}</strong>? 
              –û–±—ä–µ–∫—Ç –±—É–¥–µ—Ç –ø–æ–º–µ—á–µ–Ω –∫–∞–∫ —É–¥–∞–ª—ë–Ω–Ω—ã–π, –∞ –∏—Å—Ç–æ—Ä–∏—è –ø—Ä–æ–≤–æ–¥–æ–∫ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—Å—è.
            </p>
            <div class="wk-flex wk-gap-2 wk-justify-between">
              <button id="cancelDeleteBtn" class="wk-btn wk-btn-secondary">–û—Ç–º–µ–Ω–∞</button>
              <button id="confirmDeleteBtn" class="wk-btn wk-btn-danger">–£–¥–∞–ª–∏—Ç—å</button>
            </div>
          </div>
        </div>
      `;
      
      document.getElementById('confirmDeleteBtn').addEventListener('click', () => deleteLocation(location.id));
      document.getElementById('cancelDeleteBtn').addEventListener('click', () => {
        modalRoot.innerHTML = '';
      });
      
      modalRoot.querySelector('.modal').addEventListener('click', (e) => {
        if (e.target === e.currentTarget) {
          modalRoot.innerHTML = '';
        }
      });
    }

    async function deleteLocation(id) {
      try {
        const response = await authFetch(`/api/locations/${id}`, { 
          method: 'DELETE' 
        });
        
        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          throw new Error(errorData.error || `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${response.status}`);
        }
        
        document.getElementById('modalRoot').innerHTML = '';
        await load(); 
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è:', error);
        showError('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏: ' + error.message);
      }
    }

    function openAddModal() {
      const modalRoot = document.getElementById('modalRoot');
      modalRoot.innerHTML = `
        <div class="modal">
          <div class="modal-card">
            <h3 class="wk-card-title wk-mb-4">–î–æ–±–∞–≤–∏—Ç—å –æ–±—ä–µ–∫—Ç</h3>
            <form id="addLocationForm">
              <div class="wk-form-group">
                <label class="wk-form-label">–ù–∞–∑–≤–∞–Ω–∏–µ *</label>
                <input class="wk-form-input" name="name" required placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞">
              </div>
              <div class="wk-form-group">
                <label class="wk-form-label">–ì–æ—Ä–æ–¥</label>
                <input class="wk-form-input" name="city" placeholder="–í–≤–µ–¥–∏—Ç–µ –≥–æ—Ä–æ–¥">
              </div>
              <div class="wk-form-group">
                <label class="wk-form-label">–†–∞–π–æ–Ω</label>
                <input class="wk-form-input" name="district" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ä–∞–π–æ–Ω">
              </div>
              <div class="wk-form-group">
                <label class="wk-form-label">–ê–¥—Ä–µ—Å</label>
                <input class="wk-form-input" name="address" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–æ–ª–Ω—ã–π –∞–¥—Ä–µ—Å">
              </div>
              <div id="addLocationError" class="wk-alert wk-alert-error hidden"></div>
              <div id="addLocationSpinner" class="wk-loading hidden">
                <span class="wk-loading-spinner"></span>
                –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...
              </div>
              <div class="wk-flex wk-gap-2 wk-justify-between">
                <button type="button" id="cancelAddBtn" class="wk-btn wk-btn-secondary">–û—Ç–º–µ–Ω–∞</button>
                <button type="submit" class="wk-btn wk-btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
              </div>
            </form>
          </div>
        </div>
      `;
      
      document.getElementById('addLocationForm').addEventListener('submit', handleAddLocation);
      document.getElementById('cancelAddBtn').addEventListener('click', () => {
        modalRoot.innerHTML = '';
      });
      
      modalRoot.querySelector('.modal').addEventListener('click', (e) => {
        if (e.target === e.currentTarget) {
          modalRoot.innerHTML = '';
        }
      });
    }

    function openEditLocationModal(location) {
      const modalRoot = document.getElementById('modalRoot');
      modalRoot.innerHTML = `
        <div class="modal">
          <div class="modal-card">
            <h3 class="wk-card-title wk-mb-4">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –æ–±—ä–µ–∫—Ç</h3>
            <form id="editLocationForm">
              <div class="wk-form-group">
                <label class="wk-form-label">–ù–∞–∑–≤–∞–Ω–∏–µ *</label>
                <input class="wk-form-input" name="name" required value="${escapeHtml(location.name)}">
              </div>
              <div class="wk-form-group">
                <label class="wk-form-label">–ì–æ—Ä–æ–¥</label>
                <input class="wk-form-input" name="city" value="${location.city ? escapeHtml(location.city) : ''}">
              </div>
              <div class="wk-form-group">
                <label class="wk-form-label">–†–∞–π–æ–Ω</label>
                <input class="wk-form-input" name="district" value="${location.district ? escapeHtml(location.district) : ''}">
              </div>
              <div class="wk-form-group">
                <label class="wk-form-label">–ê–¥—Ä–µ—Å</label>
                <input class="wk-form-input" name="address" value="${location.address ? escapeHtml(location.address) : ''}">
              </div>
              <div class="wk-flex wk-gap-2 wk-justify-between">
                <button type="button" id="cancelEditLoc" class="wk-btn wk-btn-secondary">–û—Ç–º–µ–Ω–∞</button>
                <button type="submit" class="wk-btn wk-btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
              </div>
            </form>
          </div>
        </div>
      `
      document.getElementById('cancelEditLoc').onclick = () => modalRoot.innerHTML = ''
      document.getElementById('editLocationForm').onsubmit = async (e) => {
        e.preventDefault()
        const f = e.target
        const payload = {
          name: f.name.value.trim(),
          city: f.city.value.trim() || null,
          district: f.district.value.trim() || null,
          address: f.address.value.trim() || null
        }
        try {
          const resp = await authFetch(`/api/locations/${location.id}`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          })
          if (!resp.ok) {
            const j = await resp.json().catch(()=>({}))
            throw new Error(j.error || '–û—à–∏–±–∫–∞')
          }
          modalRoot.innerHTML = ''
          await load()
        } catch (err) {
          showError('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏: ' + (err.message || err))
        }
      }
    }

    async function handleAddLocation(e) {
      e.preventDefault();
      
      const form = e.target;
      const formData = new FormData(form);
      const errorEl = document.getElementById('addLocationError');
      const spinnerEl = document.getElementById('addLocationSpinner');
      
      errorEl.textContent = '';
      errorEl.classList.add('hidden');
      spinnerEl.classList.remove('hidden');
      
      const submitBtn = form.querySelector('button[type="submit"]');
      submitBtn.disabled = true;
      
      const payload = {
        name: formData.get('name').trim(),
        city: formData.get('city').trim() || null,
        district: formData.get('district').trim() || null,
        address: formData.get('address').trim() || null
      };
      
      if (!payload.name) {
        errorEl.textContent = '–ü–æ–ª–µ "–ù–∞–∑–≤–∞–Ω–∏–µ" –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è';
        errorEl.classList.remove('hidden');
        spinnerEl.classList.add('hidden');
        submitBtn.disabled = false;
        return;
      }
      
      try {
        const response = await authFetch('/api/locations', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(payload)
        });
        
        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          throw new Error(errorData.error || `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${response.status}`);
        }
        
        document.getElementById('modalRoot').innerHTML = '';
        await load(); 
        
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –æ–±—ä–µ–∫—Ç–∞:', error);
        errorEl.textContent = '–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏: ' + error.message;
        errorEl.classList.remove('hidden');
      } finally {
        spinnerEl.classList.add('hidden');
        submitBtn.disabled = false;
      }
    }

    async function load() {
      locations = await fetchLocations();
      renderLocations(locations);
    }

    function escapeHtml(text) {
      if (text === null || text === undefined) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
  </script>
</body>
</html>