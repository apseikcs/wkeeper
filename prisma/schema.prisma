generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model product {
  id              Int               @id @default(autoincrement())
  name            String
  nameNormalized  String            @unique
  unit            String
  quantity        Int
  sku             String?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  transactions    transaction[]
  transactionItem TransactionItem[]

  @@index([nameNormalized])
}

model worker {
  id           Int              @id @default(autoincrement())
  fullName     String
  phone        String?
  position     String?
  deleted      Boolean          @default(false)
  createdAt    DateTime         @default(now())
  assignments  ToolAssignment[]
  transactions transaction[]
}

model supplier {
  id           Int           @id @default(autoincrement())
  name         String        @unique
  phone        String?
  email        String?
  deleted      Boolean       @default(false)
  createdAt    DateTime      @default(now())
  transactions transaction[]
}

model location {
  id           Int           @id @default(autoincrement())
  name         String        @unique
  city         String?
  district     String?
  address      String?
  deleted      Boolean       @default(false)
  createdAt    DateTime      @default(now())
  transactions transaction[]
}

model TransactionItem {
  id            Int         @id @default(autoincrement())
  transaction   transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  transactionId Int
  product       product?    @relation(fields: [productId], references: [id], onDelete: SetNull)
  productId     Int?
  productName   String
  productSku    String?
  delta         Int

  @@index([transactionId])
  @@index([productId])
}

model transaction {
  id              Int      @id @default(autoincrement())
  type            String
  date            DateTime @default(now())
  supplierName    String? // LEGACY / display snapshot
  destinationName String? // LEGACY / display snapshot

  supplier      supplier? @relation(fields: [supplierId], references: [id], onDelete: SetNull)
  supplierId    Int?
  destination   location? @relation(fields: [destinationId], references: [id], onDelete: SetNull)
  destinationId Int?
  worker        worker?   @relation(fields: [workerId], references: [id], onDelete: SetNull)
  workerId      Int?

  author   User? @relation(fields: [authorId], references: [id], onDelete: SetNull)
  authorId Int?

  note      String?
  items     TransactionItem[]
  createdAt DateTime          @default(now())
  product   product?          @relation(fields: [productId], references: [id])
  productId Int?

  @@index([date])
  @@index([supplierId])
}

model tool {
  id                  Int              @id @default(autoincrement())
  name                String
  totalQuantity       Int              @default(1)
  availableQuantity   Int              @default(1)
  deleted             Boolean          @default(false)
  assignments         ToolAssignment[]
  createdAt           DateTime         @default(now())
  updatedAt           DateTime         @updatedAt
}

model ToolAssignment {
  id         Int       @id @default(autoincrement())
  tool       tool      @relation(fields: [toolId], references: [id], onDelete: Cascade)
  toolId     Int
  worker     worker    @relation(fields: [workerId], references: [id], onDelete: Cascade)
  workerId   Int
  quantity   Int       @default(1)
  assignedAt DateTime  @default(now())
  returnedAt DateTime?

  @@index([toolId])
  @@index([workerId])
}

model User {
  id           Int           @id @default(autoincrement())
  username     String        @unique
  passwordHash String
  role         String        @default("worker")
  permissions  Json          @default("{}")
  createdAt    DateTime      @default(now())
  transaction  transaction[]
}
